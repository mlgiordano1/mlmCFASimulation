---
title: "Masters results"
author: "Michael Giordano"
date: "April 3, 2018"
output: html_document
---

```{r setup, include=FALSE}
# setup
rm(list=ls())
library(tidyr)
library(dplyr)
library(ggplot2)
library(stringr)
library(MIIVsem)
library(knitr)
library(kableExtra)
options(knitr.table.format = "html") 
baseDir <- "c:/users/mgiordan/git/mlmcfasimulation/fullSim"
setwd(baseDir)
```

ToDo:

General setup, percent bias as figure and table rmse

summarize non-convergence

pull in parameters such as correlated error, LV var, etc.

Work in emp Se's vs mean se's

# general

```{r design, include=FALSE}
# ------------------------------------------------------------------------
# read in simulation design matrix
dm <- readRDS("c:/users/mgiordan/git/mlmcfasimulation/fullSim/simparams.rds")
dm <- dm$designMatrix
# -----------------------------------------------------------------------
```

## Between cell conditions

```{r, echo = FALSE}
# names(dm)
kable(unique(dm[,c("clusterSize", "clusterN", "clusterBal", "skewKurt")]), row.names = FALSE)
```

## Within Cell Conditions

```{r, echo = FALSE}
# names(dm)
kable(unique(dm[,c("modelSpec", "estimators")]), row.names = FALSE)
```



```{r, echo = FALSE}
# finally saving the names of within and between loadings
wl <-c("l1.by.y1",
       "l1.by.y2",
       "l1.by.y3",
       "l1.by.y5",
       "l2.by.y4",
       "l2.by.y5",
       "l2.by.y6",
       "l2.by.y2")
bl <- c("lb.by.y1",
       "lb.by.y2",
       "lb.by.y3",
       "lb.by.y4",
       "lb.by.y5",
       "lb.by.y6")
```

# true model
Here I am going to ignore the effects of skew, unbalance, and just look at relative bias and rmse for truemodels across sample sizes

## relative bias plots

```{r plots, echo = FALSE, fig.height=10, fig.width=10}
l_sub <- readRDS("c:/users/mgiordan/git/mlmcfasimulation/fullSim/finalResults/trueModelComparisons.rds")
```

## Figure 1
```{r, echo = FALSE}
# first make relative bias plots (this is more intuitive than the tables)
ggplot(l_sub[l_sub$parameter %in% wl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  # facet_grid(.~clusterSize + clusterN) +
  facet_grid(.~cluster) +  
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-50, 50)) +
  scale_y_continuous(breaks = seq(from = -50, to = 50, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Within: trueModel across sample sizes")
```

## Figure 2

```{r, echo = FALSE}
ggplot(l_sub[l_sub$parameter %in% bl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  facet_grid(.~cluster) + 
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-100, 100)) +
  scale_y_continuous(breaks = seq(from = -100, to = 100, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Between: true model across sample sizes")
```


```{r summarystats, echo = FALSE}
# now computing summary stats by group
r <- l_sub %>%
  group_by(cluster, clusterBal, skewKurt, modelSpec, estimators, parameter) %>%
  summarize(count = n(),
            mean = mean(est, na.rm = TRUE),
            se = sd(est, na.rm = TRUE),
            meanBias = mean(p_relBias, na.rm = TRUE), 
            rmse = sqrt(sum((est-true)^2, na.rm = TRUE)/n()))

# collecting just the loadings
rp <- r[r$parameter %in% c(bl, wl), ]

# reshaping wide by estimator
# ------------------------------------------------------------------------------
bias <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "meanBias" )
# bias <- as.matrix(bias, )
colnames(bias) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# ------------------------------------------------------------------------------
rmse <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "rmse" )
# rmse <- as.matrix(rmse)
colnames(rmse) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))

# -----------------------------------------------------------------------------
# Check Standard Errors
# take the se from r
rSe <- r[r$parameter %in% paste0(c(bl, wl),".se"), ]
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "mean")]
rSe$parameter <- substr(rSe$parameter, 0, 8)
rSe$meanSE <- rSe$mean
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "meanSE")]

se <- merge(rp, rSe)
se$EmpSe_mnSe <- paste0(round(se$se, digits = 3), " (", round(se$meanSE, 3), ")")

se <- reshape2::dcast(se, parameter ~ cluster + estimators, 
                        value.var = "EmpSe_mnSe" )
colnames(se) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
```

## Table 1: TRue Model Relative Bias

```{r, echo = FALSE}
knitr::kable(bias, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 2: True Model RMSE

```{r, echo = FALSE}
knitr::kable(rmse, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 3: True Model Standard Errors table (Emp_se (meanSE))

```{r, echo = FALSE}
knitr::kable(se, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```


# MisSpecW1
## relative bias plots

note that the non-finite values warning here is for the missing loading l1.by.y5 (7200 are those, then 5 that are apparently problematic)


```{r MisSpecW1 plots, echo = FALSE, fig.height=10, fig.width=10}
l_sub <- readRDS("c:/users/mgiordan/git/mlmcfasimulation/fullSim/finalResults/misW1Comparisons.rds")
```

## Figure 3: Misspecification #1 Within Loadings

```{r, echo = FALSE}
# first make relative bias plots (this is more intuitive than the tables)
ggplot(l_sub[l_sub$parameter %in% wl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  # facet_grid(.~clusterSize + clusterN) +
  facet_grid(.~cluster) +  
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-50, 50)) +
  scale_y_continuous(breaks = seq(from = -50, to = 50, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Within: trueModel across sample sizes")
```

# Figure 4: Misspecification #1 Between Loadings

```{r, echo = FALSE}
ggplot(l_sub[l_sub$parameter %in% bl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  facet_grid(.~cluster) + 
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-100, 100)) +
  scale_y_continuous(breaks = seq(from = -100, to = 100, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Between: true model across sample sizes")
```


```{r MisSpecW1 summarystats, echo = FALSE}
# now computing summary stats by group
r <- l_sub %>%
  group_by(cluster, clusterBal, skewKurt, modelSpec, estimators, parameter) %>%
  summarize(count = n(),
            mean = mean(est, na.rm = TRUE),
            se = sd(est, na.rm = TRUE),
            meanBias = mean(p_relBias, na.rm = TRUE), 
            rmse = sqrt(sum((est-true)^2, na.rm = TRUE)/n()))

# collecting just the loadings
rp <- r[r$parameter %in% c(bl, wl), ]

# reshaping wide by estimator
# ------------------------------------------------------------------------------
bias <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "meanBias" )
# bias <- as.matrix(bias, )
colnames(bias) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# ------------------------------------------------------------------------------
rmse <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "rmse" )
# rmse <- as.matrix(rmse)
colnames(rmse) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# -----------------------------------------------------------------------------
# Check Standard Errors
# take the se from r
rSe <- r[r$parameter %in% paste0(c(bl, wl),".se"), ]
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "mean")]
rSe$parameter <- substr(rSe$parameter, 0, 8)
rSe$meanSE <- rSe$mean
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "meanSE")]

se <- merge(rp, rSe)
se$EmpSe_mnSe <- paste0(round(se$se, digits = 3), " (", round(se$meanSE, 3), ")")

se <- reshape2::dcast(se, parameter ~ cluster + estimators, 
                        value.var = "EmpSe_mnSe" )
colnames(se) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
```

## Table 4: Bias table

```{r, echo = FALSE}
knitr::kable(bias, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 5: RMSE

```{r, echo = FALSE}
knitr::kable(rmse, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 6: Standard Errors (Emp_se (meanSE))

```{r, echo = FALSE}
knitr::kable(se, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

# MisSpecW2

## relative bias plots

note that the non-finite values warning here is for the missing loading l1.by.y5 (7200 are those, then 5 that are apparently problematic)

```{r MisSpecW2 plots, echo = FALSE, fig.height=10, fig.width=10}
l_sub <- readRDS("c:/users/mgiordan/git/mlmcfasimulation/fullSim/finalResults/misW2Comparisons.rds")
```

## Figure 5: Misspecification #2 Within Loadings

```{r, echo = FALSE}
# first make relative bias plots (this is more intuitive than the tables)
ggplot(l_sub[l_sub$parameter %in% wl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  # facet_grid(.~clusterSize + clusterN) +
  facet_grid(.~cluster) +  
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-50, 50)) +
  scale_y_continuous(breaks = seq(from = -50, to = 50, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Within: trueModel across sample sizes")
```

## Figure 6: Misspecification #2 between loadings

```{r, echo = FALSE}
ggplot(l_sub[l_sub$parameter %in% bl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  facet_grid(.~cluster) + 
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-100, 100)) +
  scale_y_continuous(breaks = seq(from = -100, to = 100, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Between: true model across sample sizes")
```


```{r MisSpecW2 summarystats, echo = FALSE}
# now computing summary stats by group
r <- l_sub %>%
  group_by(cluster, clusterBal, skewKurt, modelSpec, estimators, parameter) %>%
  summarize(count = n(),
            mean = mean(est, na.rm = TRUE),
            se = sd(est, na.rm = TRUE),
            meanBias = mean(p_relBias, na.rm = TRUE), 
            rmse = sqrt(sum((est-true)^2, na.rm = TRUE)/n()))

# collecting just the loadings
rp <- r[r$parameter %in% c(bl, wl), ]

# reshaping wide by estimator
# ------------------------------------------------------------------------------
bias <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "meanBias" )
# bias <- as.matrix(bias, )
colnames(bias) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# ------------------------------------------------------------------------------
rmse <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "rmse" )
# rmse <- as.matrix(rmse)
colnames(rmse) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# -----------------------------------------------------------------------------
# Check Standard Errors
# take the se from r
rSe <- r[r$parameter %in% paste0(c(bl, wl),".se"), ]
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "mean")]
rSe$parameter <- substr(rSe$parameter, 0, 8)
rSe$meanSE <- rSe$mean
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "meanSE")]

se <- merge(rp, rSe)
se$EmpSe_mnSe <- paste0(round(se$se, digits = 3), " (", round(se$meanSE, 3), ")")

se <- reshape2::dcast(se, parameter ~ cluster + estimators, 
                        value.var = "EmpSe_mnSe" )
colnames(se) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
```

## Table 7: bias

```{r, echo = FALSE}
knitr::kable(bias, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 8: RMSE table

```{r, echo = FALSE}
knitr::kable(rmse, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 9: SE table (Emp_se (meanSE))

```{r, echo = FALSE}
knitr::kable(se, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```


# MisSpecW3

## relative bias plots

note that the non-finite values warning here is for the missing loading l1.by.y5 (7200 are those, then 5 that are apparently problematic)

```{r MisSpecW3 plots, echo = FALSE, fig.height=10, fig.width=10}
l_sub <- readRDS("c:/users/mgiordan/git/mlmcfasimulation/fullSim/finalResults/misW3Comparisons.rds")
```

## Figure 7: Misspecification #3 within loadings

```{r, echo = FALSE}
# first make relative bias plots (this is more intuitive than the tables)
ggplot(l_sub[l_sub$parameter %in% wl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  # facet_grid(.~clusterSize + clusterN) +
  facet_grid(.~cluster) +  
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-50, 50)) +
  scale_y_continuous(breaks = seq(from = -50, to = 50, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Within: trueModel across sample sizes")
```

## Figure 8: Misspecification #3 between loadings

```{r, echo = FALSE}
ggplot(l_sub[l_sub$parameter %in% bl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  facet_grid(.~cluster) + 
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-100, 100)) +
  scale_y_continuous(breaks = seq(from = -100, to = 100, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Between: true model across sample sizes")
```


```{r MisSpecW3 summarystats, echo = FALSE}
# now computing summary stats by group
r <- l_sub %>%
  group_by(cluster, clusterBal, skewKurt, modelSpec, estimators, parameter) %>%
  summarize(count = n(),
            mean = mean(est, na.rm = TRUE),
            se = sd(est, na.rm = TRUE),
            meanBias = mean(p_relBias, na.rm = TRUE), 
            rmse = sqrt(sum((est-true)^2, na.rm = TRUE)/n()))

# collecting just the loadings
rp <- r[r$parameter %in% c(bl, wl), ]

# reshaping wide by estimator
# ------------------------------------------------------------------------------
bias <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "meanBias" )
# bias <- as.matrix(bias, )
colnames(bias) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# ------------------------------------------------------------------------------
rmse <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "rmse" )
# rmse <- as.matrix(rmse)
colnames(rmse) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# -----------------------------------------------------------------------------
# Check Standard Errors
# take the se from r
rSe <- r[r$parameter %in% paste0(c(bl, wl),".se"), ]
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "mean")]
rSe$parameter <- substr(rSe$parameter, 0, 8)
rSe$meanSE <- rSe$mean
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "meanSE")]

se <- merge(rp, rSe)
se$EmpSe_mnSe <- paste0(round(se$se, digits = 3), " (", round(se$meanSE, 3), ")")

se <- reshape2::dcast(se, parameter ~ cluster + estimators, 
                        value.var = "EmpSe_mnSe" )
colnames(se) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
```

## Table 10 bias 

```{r, echo = FALSE}
knitr::kable(bias, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 11 RMSE

```{r, echo = FALSE}
knitr::kable(rmse, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 12 Standard Errors (Emp_se (meanSE))

```{r, echo = FALSE}
knitr::kable(se, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```


# Skew/Kurtosis

There wasn't too much effect here honestly. In future studies it might be worth pushing around a bit more. But for the time being at least we know that these are at least mildly robust to skew/kurtosis.

Results here are for cells with 100 clusters of 30. I thought that was the most interesting. 100 of 100 was too large, 30 of 30 was too small (still looked ok though).

## relative bias plots

```{r skew kurt plots, echo = FALSE, fig.height=10, fig.width=10}
l_sub <- readRDS("c:/users/mgiordan/git/mlmcfasimulation/fullSim/finalResults/skewKurt.rds")
```

## Figure 9: Skew Kurtosis Condition within Loadings

```{r, echo = FALSE}
# first make relative bias plots (this is more intuitive than the tables)
ggplot(l_sub[l_sub$parameter %in% wl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  # facet_grid(.~clusterSize + clusterN) +
  facet_grid(.~skewKurt) +  
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-50, 50)) +
  scale_y_continuous(breaks = seq(from = -50, to = 50, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Within: trueModel across sample sizes")
```

## Figure 10: Skew Kurtosis Conditions between loadings

```{r, echo = FALSE}
ggplot(l_sub[l_sub$parameter %in% bl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  facet_grid(.~skewKurt) + 
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-100, 100)) +
  scale_y_continuous(breaks = seq(from = -100, to = 100, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Between: true model across sample sizes")
```


```{r skewkurt summarystats, echo = FALSE}
# now computing summary stats by group
r <- l_sub %>%
  group_by(cluster, clusterBal, skewKurt, modelSpec, estimators, parameter) %>%
  summarize(count = n(),
            mean = mean(est, na.rm = TRUE),
            se = sd(est, na.rm = TRUE),
            meanBias = mean(p_relBias, na.rm = TRUE), 
            rmse = sqrt(sum((est-true)^2, na.rm = TRUE)/n()))

# collecting just the loadings
rp <- r[r$parameter %in% c(bl, wl), ]

# reshaping wide by estimator
# ------------------------------------------------------------------------------
bias <- reshape2::dcast(rp, parameter ~ skewKurt + estimators, 
                        value.var = "meanBias" )
# bias <- as.matrix(bias, )
colnames(bias) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# ------------------------------------------------------------------------------
rmse <- reshape2::dcast(rp, parameter ~ skewKurt + estimators, 
                        value.var = "rmse" )
# rmse <- as.matrix(rmse)
colnames(rmse) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# ------------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Check Standard Errors
# take the se from r
rSe <- r[r$parameter %in% paste0(c(bl, wl),".se"), ]
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "mean")]
rSe$parameter <- substr(rSe$parameter, 0, 8)
rSe$meanSE <- rSe$mean
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "meanSE")]

se <- merge(rp, rSe)
se$EmpSe_mnSe <- paste0(round(se$se, digits = 3), " (", round(se$meanSE, 3), ")")

se <- reshape2::dcast(se, parameter ~ skewKurt + estimators, 
                        value.var = "EmpSe_mnSe" )
colnames(se) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))

```

## Table 13: bias 

```{r, echo = FALSE}
knitr::kable(bias, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "0000 - MVN" = 3, 
                     "0028 - btw skew" = 3, 
                     "2800 - within skew" = 3,
                     "2828 both skew" = 3))
```

## Table 14: RMSE 

```{r, echo = FALSE}
knitr::kable(rmse, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "0000 - MVN" = 3, 
                     "0028 - btw skew" = 3, 
                     "2800 - within skew" = 3,
                     "2828 both skew" = 3))
```

## Table 15: SE  (Emp_se (meanSE))

```{r, echo = FALSE}
knitr::kable(se, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "0000 - MVN" = 3, 
                     "0028 - btw skew" = 3, 
                     "2800 - within skew" = 3,
                     "2828 both skew" = 3))
```

# Balance/Unbalance


## relative bias plots

```{r balance plots, echo = FALSE, fig.height=10, fig.width=10}
l_sub <- readRDS("c:/users/mgiordan/git/mlmcfasimulation/fullSim/finalResults/unbalance.rds")
```

## Figure 11: Unbalanced condition within loadings

```{r, echo = FALSE}
# first make relative bias plots (this is more intuitive than the tables)
ggplot(l_sub[l_sub$parameter %in% wl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  # facet_grid(.~clusterSize + clusterN) +
  facet_grid(.~cluster) +  
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-50, 50)) +
  scale_y_continuous(breaks = seq(from = -50, to = 50, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Within: trueModel across sample sizes")
```

## Figure 12: Unbalanced condition between loadings

```{r, echo = FALSE}
ggplot(l_sub[l_sub$parameter %in% bl,], aes(x=parameter, y = p_relBias, fill = estimators)) +
  geom_boxplot() +
  facet_grid(.~cluster) + 
  stat_summary(fun.y = mean, geom="point",colour="darkred", size=1, 
    position = position_dodge(width = .75)) +
  geom_hline(yintercept = 20) + 
  geom_hline(yintercept = -20) + 
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  coord_cartesian(ylim=c(-100, 100)) +
  scale_y_continuous(breaks = seq(from = -100, to = 100, by = 10)) +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5)) +
  ggtitle("Between: true model across sample sizes")
```


```{r balance summarystats, echo = FALSE}
# now computing summary stats by group
r <- l_sub %>%
  group_by(cluster, clusterBal, skewKurt, modelSpec, estimators, parameter) %>%
  summarize(count = n(),
            mean = mean(est, na.rm = TRUE),
            se = sd(est, na.rm = TRUE),
            meanBias = mean(p_relBias, na.rm = TRUE), 
            rmse = sqrt(sum((est-true)^2, na.rm = TRUE)/n()))

# collecting just the loadings
rp <- r[r$parameter %in% c(bl, wl), ]

# reshaping wide by estimator
# ------------------------------------------------------------------------------
bias <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "meanBias" )
# bias <- as.matrix(bias, )
colnames(bias) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# ------------------------------------------------------------------------------
rmse <- reshape2::dcast(rp, parameter ~ cluster + estimators, 
                        value.var = "rmse" )
# rmse <- as.matrix(rmse)
colnames(rmse) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
# -----------------------------------------------------------------------------
# Check Standard Errors
# take the se from r
rSe <- r[r$parameter %in% paste0(c(bl, wl),".se"), ]
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "mean")]
rSe$parameter <- substr(rSe$parameter, 0, 8)
rSe$meanSE <- rSe$mean
rSe <- rSe[, c("cluster", "clusterBal", "skewKurt", "modelSpec", "estimators",
  "parameter", "meanSE")]

se <- merge(rp, rSe)
se$EmpSe_mnSe <- paste0(round(se$se, digits = 3), " (", round(se$meanSE, 3), ")")

se <- reshape2::dcast(se, parameter ~ cluster + estimators, 
                        value.var = "EmpSe_mnSe" )
colnames(se) <- c("parameter", rep(c("FIML", "Gold", "MUML"), 4))
```

## Table 16: bias 

```{r, echo = FALSE}
knitr::kable(bias, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 17: RMSE table

```{r, echo = FALSE}
knitr::kable(rmse, digits = 3, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```

## Table 18: Standard Errors (Emp_se (meanSE))

```{r, echo = FALSE}
knitr::kable(se, row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  add_header_above(c(" " = 1, 
                     "100 of 100" = 3, 
                     "100 of 30" = 3, 
                     "30 of 100" = 3,
                     "30 of 30" = 3))
```


